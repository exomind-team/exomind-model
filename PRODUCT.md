# Voice-ime 产品定义

> **项目**: Voice-ime 语音输入引擎
> **版本**: v1.0
> **创建日期**: 2026-01-29
> **优先级**: P0（产品定义，季度更新）

---

## 1. 产品愿景

### 1.1 一句话描述

打造一个本地优先、零配置的语音输入引擎，支持 ASR（语音识别）和 TTS（语音合成），作为外心系统的语音交互入口。

### 1.2 核心价值

| 价值点 | 说明 |
|--------|------|
| **本地优先** | 优先使用本地引擎，减少网络依赖 |
| **零配置** | 新用户无需复杂配置即可使用 |
| **多引擎** | 支持 FunASR、MOSS、Sherpa-ONNX 等 |
| **自动回退** | 失败时自动切换到备选方案 |

### 1.3 目标用户

- **星林（HailayLin）**: 计算机系学生，构建"认知生命科学"系统
- **偏好**: 本地优先、自动化、从原理理解技术

---

## 2. 核心功能

### 2.1 必做功能（MVP）

| 功能 | 优先级 | 说明 |
|------|--------|------|
| ASR 语音转文字 | P0 | FunASR 本地引擎 |
| TTS 文字转语音 | P0 | Sherpa-ONNX 本地引擎 |
| HTTP API 服务 | P0 | FastAPI 服务 |
| 引擎自动回退 | P1 | 失败时自动切换 |

### 2.2 ASR 引擎支持

| 引擎 | 类型 | 特点 | 状态 |
|------|------|------|------|
| **FunASR (paraformer-zh)** | 本地 | 4x 实时率，带时间戳 | ✅ 完成 |
| **Fun-ASR-Nano-2512** | 本地 | 实时流式，<600ms 延迟 | ✅ 完成 |
| **MOSS** | 云端 | 支持说话人分离 | ✅ 完成 |

### 2.3 TTS 引擎支持

| 引擎 | 类型 | 说话人数 | 状态 |
|------|------|---------|------|
| **vits-zh-hf-fanchen-C** | 本地 | 187 | ✅ 完成 |
| **kokoro-multi-lang-v1_1** | 本地 | 103 | ✅ 完成 |

---

## 3. 系统架构

### 3.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                     Voice-ime Core                       │
├─────────────────────────────────────────────────────────┤
│  ┌───────────┐  ┌───────────┐  ┌─────────────────────┐  │
│  │   ASR     │  │   TTS     │  │     Engine Factory  │  │
│  │  Engine   │  │  Engine   │  │     (工厂模式)       │  │
│  └─────┬─────┘  └─────┬─────┘  └──────────┬──────────┘  │
│        │              │                    │             │
│  ┌─────┴─────┐  ┌─────┴─────┐     ┌───────┴───────┐    │
│  │ FunASR    │  │Sherpa-    │     │  热切换/回退   │    │
│  │ MOSS      │  │ONNX VITS  │     │  机制          │    │
│  └───────────┘  └───────────┘     └───────────────┘    │
└─────────────────────────────────────────────────────────┘
```

### 3.2 核心技术栈

| 层级 | 技术 | 说明 |
|------|------|------|
| 语言 | Python | 主开发语言 |
| 框架 | FastAPI | Web 框架 |
| ASR 引擎 | FunASR, Fun-ASR-Nano-2512, MOSS | 语音识别 |
| TTS 引擎 | Sherpa-ONNX (VITS, Kokoro) | 语音合成 |
| 部署 | systemd --user | 服务部署 |

### 3.3 服务架构

```
voice-ime/                          # 后端服务
├── asr/                            # ASR 引擎模块
├── tts/                            # TTS 引擎模块
├── speaker/                        # 说话人识别模块
├── service/                        # FastAPI 服务
│   ├── main.py                     # FastAPI 应用入口
│   ├── api/                        # API 端点
│   │   ├── asr.py                  # ASR 端点
│   │   ├── tts.py                  # TTS 端点
│   │   ├── admin.py                # Admin 端点
│   │   └── docs.py                 # 文档端点
│   ├── models/                     # Pydantic 数据模型
│   └── config.py                   # 配置管理
```

---

## 4. API 端点设计

### 4.1 MVP 端点

| 端点 | 方法 | 描述 |
|------|------|------|
| `/v1/asr/transcribe` | POST | ASR 转写 |
| `/v1/tts/synthesize` | POST | TTS 合成 |
| `/v1/admin/status` | GET | 服务状态 |
| `/v1/docs/agent` | GET | Agent 专用文档 |
| `/docs` | GET | Swagger UI |

### 4.2 文档体系

| 层级 | 端点 | 用途 |
|------|------|------|
| 层级 1 | `/docs` | Swagger UI - 人类交互式调试 |
| 层级 2 | `/openapi.json` | OpenAPI Schema - 机器可读 |
| 层级 3 | `/v1/docs/agent` | Agent 专用提示词 - AI 专用 |

---

## 5. 成功指标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| **RTF (实时因子)** | < 1.0 | ASR/TTS 推理速度 |
| **ASR 延迟** | < 600ms | Fun-ASR-Nano-2512 流式延迟 |
| **TTS 实时率** | 100% | 27/27 音色满足实时生成 |
| **单元测试覆盖率** | > 80% | 核心功能测试覆盖 |
| **本地引擎可用性** | 100% | 无网络时核心功能可用 |

---

## 6. 约束与风险

### 6.1 约束条件

| 约束 | 说明 |
|------|------|
| **本地优先** | 优先使用本地引擎，减少网络依赖 |
| **零配置** | 新用户无需 API Key 即可使用 |
| **资源占用** | 模型 < 4GB 显存，支持消费级 GPU |
| **平台支持** | Linux (Ubuntu 24.04) |

### 6.2 已知风险

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 模型版本升级 | 兼容性问题 | 版本锁定，MODEL_REPO_MAP 映射 |
| 外部依赖变更 | 功能异常 | 测试覆盖，版本控制 |
| GPU 资源不足 | 性能下降 | CPU 回退，资源监控 |

---

## 7. 文档关系

| 文档 | 优先级 | 说明 |
|------|--------|------|
| **PRODUCT.md** | P0 | 本文档，产品定义（季度更新） |
| **PRD.md** | P1 | 详细需求（任务清单、踩坑记录，月度更新） |
| **tasks_plan.md** | P2 | 任务计划（周更新） |

### Ralph Loop 读取优先级

```
步骤 0 读取优先级：
├── pm/input.md         ← 最高优先级（日更新）
├── pm/PRODUCT.md       ← P0 产品定义（季度更新）
├── pm/tasks_plan.md    ← P2 任务计划（周更新）
└── pm/PRD.md           ← P1 详细需求（月度更新）
```

---

## 8. 版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| v1.0 | 2026-01-29 | 初始版本，从 PRD.md 拆分 |

---

*本文档遵循 life-os/core/memory-workflow.md 更新规范*
*最后更新: 2026-01-29*
